name: Generate Metrics
on:
    schedule:
        - cron: "0 */12 * * *" # every 12 hours
    workflow_dispatch:
env:
    METRICS_USER: envoy1084
    METRICS_TZ: Asia/Calcutta
    OUTPUT_BRANCH: output
    OUTPUT_ACTION: commit
    OUTPUT_COMMIT_MESSAGE: "chore: update metrics"
jobs:
    github-metrics:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate Overview
              uses: lowlighter/metrics@latest
              with:
                  # Base Options
                  token: ${{ secrets.METRICS_TOKEN }}
                  config_timezone: ${{ env.METRICS_TZ }}
                  output_action: ${{ env.OUTPUT_ACTION }}
                  committer_branch: ${{ env.OUTPUT_BRANCH }}
                  committer_message: ${{ env.OUTPUT_COMMIT_MESSAGE }}
                  user: ${{ env.METRICS_USER }}

                  filename: metrics.plugin.overview.svg
                  base: header, activity, community, repositories, metadata
            - name: Generate Isometric Calendar
              uses: lowlighter/metrics@latest
              with:
                  # Base Options
                  token: ${{ secrets.METRICS_TOKEN }}
                  config_timezone: ${{ env.METRICS_TZ }}
                  output_action: ${{ env.OUTPUT_ACTION }}
                  committer_branch: ${{ env.OUTPUT_BRANCH }}
                  committer_message: ${{ env.OUTPUT_COMMIT_MESSAGE }}
                  user: ${{ env.METRICS_USER }}

                  filename: metrics.plugin.isocalendar.fullyear.svg
                  base: ""
                  plugin_isocalendar: yes
                  plugin_isocalendar_duration: full-year
            - name: Generate Activity
              uses: lowlighter/metrics@latest
              with:
                  # Base Options
                  token: ${{ secrets.METRICS_TOKEN }}
                  config_timezone: ${{ env.METRICS_TZ }}
                  output_action: ${{ env.OUTPUT_ACTION }}
                  committer_branch: ${{ env.OUTPUT_BRANCH }}
                  committer_message: ${{ env.OUTPUT_COMMIT_MESSAGE }}
                  user: ${{ env.METRICS_USER }}

                  filename: metrics.plugin.activity.svg
                  base: ""
                  plugin_activity: yes
                  plugin_activity_days: 14
                  plugin_activity_filter: all
                  plugin_activity_limit: 5
                  plugin_activity_load: 300
                  plugin_activity_visibility: all
            - name: Generate Blog Posts
              uses: lowlighter/metrics@latest
              with:
                  # Base Options
                  token: NOT_NEEDED
                  config_timezone: ${{ env.METRICS_TZ }}
                  output_action: ${{ env.OUTPUT_ACTION }}
                  committer_branch: ${{ env.OUTPUT_BRANCH }}
                  committer_message: ${{ env.OUTPUT_COMMIT_MESSAGE }}
                  user: ${{ env.METRICS_USER }}

                  filename: metrics.plugin.blog.svg
                  base: ""
                  plugin_posts: yes
                  plugin_posts_source: hashnode
                  plugin_posts_limit: 4
                  plugin_posts_user: Envoy1084
                  plugin_posts_descriptions: yes
                  plugin_posts_covers: yes
            - name: Generate Wakatime
              uses: lowlighter/metrics@latest
              with:
                  # Base Options
                  token: ${{ secrets.METRICS_TOKEN }}
                  config_timezone: ${{ env.METRICS_TZ }}
                  output_action: ${{ env.OUTPUT_ACTION }}
                  committer_branch: ${{ env.OUTPUT_BRANCH }}
                  committer_message: ${{ env.OUTPUT_COMMIT_MESSAGE }}
                  user: ${{ env.METRICS_USER }}

                  filename: metrics.plugin.wakatime.svg
                  base: ""
                  plugin_wakatime: yes
                  plugin_wakatime_token: ${{ secrets.WAKATIME_API_KEY }}
                  plugin_wakatime_days: 365
                  plugin_wakatime_languages_other: yes
                  plugin_wakatime_limit: 5
                  plugin_wakatime_repositories_visibility: all
                  plugin_wakatime_sections: time, projects, projects-graphs, languages, languages-graphs, editors, os
                  plugin_wakatime_url: https://wakatime.com
                  plugin_wakatime_user: current
            - name: Generate Snake Game
              uses: Platane/snk@v3
              with:
                  github_user_name: ${{ env.METRICS_USER }}
                  outputs: |
                      github-snake.svg
                      github-snake-dark.svg?palette=github-dark
            - name: This repo has x stars y forks
              uses: ouuan/This-repo-has-x-stars-y-forks-action@v2
              with:
                  token: ${{ secrets.METRICS_TOKEN }}
                  template: "A profile README with <starCount> stars and <forkCount> forks ðŸŒŸ"
            - name: Publish snake files to output branch
              run: |
                  set -euo pipefail

                  # Use GitHub Actions bot identity
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Fetch all branches
                  git fetch origin --no-tags --prune

                  # Remove old worktree folder
                  rm -rf output || true

                  # Create worktree for output branch (create if doesn't exist)
                  if git ls-remote --heads origin "$OUTPUT_BRANCH" > /dev/null; then
                  git worktree add output origin/"$OUTPUT_BRANCH"
                  else
                  git worktree add -B "$OUTPUT_BRANCH" output
                  fi

                  # ------------------------------------
                  # Copy files to root of output branch
                  # ------------------------------------
                  rm -f github-snake.svg github-snake-dark.svg || true

                  cp -v github-snake.svg output/ || true
                  cp -v github-snake-dark.svg output/ || true

                  # ------------------------------------
                  # Commit & push only if changes exist
                  # ------------------------------------
                  cd output

                  if git status --porcelain | grep -q .; then
                  git add .
                  git commit -m "chore: update snake files"
                  git push origin --force "$OUTPUT_BRANCH"
                  else
                  echo "No changes to commit"
                  fi

                  cd ..
